# heywhale_contest_code
- æ¨¡å‹æ–‡ä»¶ç½®äºè·¯å¾„[my_model](./project/my_model)ä¸‹å³å¯æ¨ç†ã€‚
  - å¦‚éœ€å¤šæ¨¡å‹ç»“æœæŠ•ç¥¨ï¼Œå¯å°†å¦å¤– **2** ä¸ªä»¥ä¸Š *bin* æ–‡ä»¶æ¨¡å‹ï¼ˆåå­—ä»¥"pytorch_model"èµ·å¤´ï¼Œå¦‚"pytorch_model_1.bin"ï¼‰ç½®äºè·¯å¾„[project/my_model/other_models](./project/my_model/other_models)ä¸‹ï¼Œå³å¯è‡ªåŠ¨å¤šæ¨¡å‹ç»“æœæŠ•ç¥¨ã€‚
  - å¦‚éœ€åŠç²¾åº¦æ¨ç†ï¼Œåªéœ€è¦å–æ¶ˆæ³¨é‡Š[predict.py](./project/predict.py)ä¸­çš„ *model.half()* æŒ‡ä»¤å³å¯ã€‚
- å¦‚éœ€åœ¨æœ¬åœ°æµ‹è¯•ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‡ è¡Œå‘½ä»¤ï¼š
```
cd project
import index
index.invoke('./data/test.csv', './data/pred.csv')
```
# æäº¤å®¡æ ¸README

# ä»£ç è¯´æ˜  

## ç¯å¢ƒé…ç½®  
æœ¬é¡¹ç›®è®­ç»ƒä½¿ç”¨çš„ç®—åŠ›èµ„æºå‹å·ä¸ºã€Œå•å¡ V100 GPU èµ„æºã€ï¼Œä½¿ç”¨åŸºäºå®˜æ–¹é•œåƒç”Ÿæˆçš„è‡ªå®šä¹‰é•œåƒâ€œå•Šå•Šå•Š+å¤ç°é•œåƒâ€(æäº¤å®¡æ ¸çš„é‚£ä¸ªç‰ˆæœ¬å†™æˆäº†"å•Šå•Šå•Šå¤ç°é•œåƒ"ï¼ŒğŸ¤¦)
åŒ…æ‹¬ä»¥ä¸‹é¢å¤–çš„å®‰è£…åŒ…ï¼š  
- datasets==2.10.1  
- nltk==3.8.1  
- deepspeed==0.8.3  
- argparse==1.1  
- opencv-python==4.5.5.64  

## é¢„è®­ç»ƒæ¨¡å‹  
ä½¿ç”¨äº†â€œfnlp/bart-largeâ€é¢„è®­ç»ƒæ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹ linux å‘½ä»¤æ–¹å¼è·å¾—ï¼š  
```
# Make sure you have git-lfs installed (https://git-lfs.com)  
git lfs install  
git clone https://huggingface.co/fnlp/bart-large-chinese  
```
## ç®—æ³•  

### æ•´ä½“æ€è·¯ä»‹ç»ï¼ˆå¿…é€‰ï¼‰  

- é¢„è®­ç»ƒï¼šé¢„è®­ç»ƒæ¨¡å‹çš„åµŒå…¥å±‚ **shared layer**ï¼ˆå³æ‰€è°“çš„ word embedding layerï¼‰å¤§å°è¿›è¡Œè°ƒæ•´ï¼Œå¹¶å¯¹é™¤ special tokens ä»¥å¤–çš„ tokens å¯¹åº”çš„ embedding å‘é‡è¿›è¡Œéšæœºåˆå§‹åŒ–ã€‚ç„¶åï¼Œåœ¨åˆèµ› + å¤èµ›çš„æ•°æ®ä¸Šåšéšæœº n gram mask é¢„è®­ç»ƒã€‚  
- å¾®è°ƒï¼šé‡‡ç”¨ k fold æ¥äº¤å‰éªŒè¯ï¼Œè®­ç»ƒå¾—åˆ° n (æ­¤å¤„ä¸º3)ä¸ªæ¨¡å‹ã€‚ä½¿ç”¨ä¸€äº› trick æå‡æ¨¡å‹çš„æ³›åŒ–æ€§ã€‚  
- æ¨ç†ï¼šç”¨å¾®è°ƒé˜¶æ®µå¾—åˆ°çš„ n ä¸ªæ¨¡å‹è¿›è¡Œæ¨ç†å¾—åˆ°å„è‡ªçš„è¾“å‡º sentence ç»“æœï¼Œç„¶åé‡‡ç”¨æŠ•ç¥¨çš„æ–¹å¼æŠ‰æ‹©å‡ºæœ€ä¼˜çš„ sentenceï¼ˆè¯¦è§â€œæ–¹æ³•çš„åˆ›æ–°ç‚¹â€èŠ‚ï¼‰ã€‚  

### æ–¹æ³•çš„åˆ›æ–°ç‚¹ï¼ˆå¯é€‰ï¼‰  
 - åœ¨é¢„è®­ç»ƒé˜¶æ®µéšæœºé€‰æ‹© **n gram tokens span** è¿›è¡Œ **mask**ï¼Œæ¯ä¸ªè¢« mask çš„ span ç”¨ 1 ä¸ª [MASK] æ¥ä»£æ›¿ï¼Œè®©æ¨¡å‹æ ¹æ®ä¸Šä¸‹æ–‡å»ä» 1 ä¸ª [MASK] ä¸­è¿˜åŸå‡ºåŸæ¥çš„ n gram tokens spanï¼Œä»è€Œå­¦åˆ°ç”Ÿæˆèƒ½åŠ›ã€‚  
 - ä½¿ç”¨ **R-Drop**(Regularized Dropout )æ¥æ¶ˆé™¤æ¨¡å‹è®­ç»ƒé˜¶æ®µå’Œæ¨ç†é˜¶æ®µçš„**GAP**ï¼šå› ä¸ºæ¨¡å‹åœ¨æ¨ç†é˜¶æ®µæ˜¯å…³é—­ dropout çš„ï¼Œä¸è®­ç»ƒé˜¶æ®µä¸åŒï¼Œé‡‡ç”¨ R-Drop å¯ä»¥ä½¿å¾—æ¨¡å‹å¯¹ dropout çš„å¹²æ‰°æ›´åŠ é²æ£’ï¼Œä»è€Œåœ¨æ¨ç†é˜¶æ®µä¿æŒè¾ƒå¥½çš„æ€§èƒ½ã€‚  
 - ä½¿ç”¨ **label smoothing** ä½¿å¾—æ¨¡å‹ä¸è¦è¿‡åº¦è‡ªä¿¡ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦è¾ƒå°‘è¿‡æ‹Ÿåˆï¼Œæå‡æ³›åŒ–æ€§ã€‚  
 - ä½¿ç”¨ **FGM** (fast gradient method)å¯¹æŠ—è®­ç»ƒï¼Œåœ¨ finetune é˜¶æ®µå¯¹åµŒå…¥å±‚è¿›è¡Œæ‰°åŠ¨ï¼Œå¢åŠ æ¨¡å‹é²æ£’æ€§ã€‚  
 - ä½¿ç”¨ **åˆ†å±‚å­¦ä¹ ç‡**ï¼Œå¢å¤§åµŒå…¥å±‚çš„å­¦ä¹ ç‡ï¼Œè®©æ¨¡å‹åŠ å…¥æ”¶æ•›ã€‚  
 - å¤šä¸ªæ¨¡å‹ç»“æœ **æŠ•ç¥¨**ï¼Œåœ¨å¾—åˆ°å¤šä¸ªæ¨¡å‹çš„æ¨ç†ç»“æœåï¼Œè®©å®ƒä»¬çš„ç»“æœä¹‹é—´äº’ç›¸æŠ•ç¥¨ï¼š  
 > 1. ç»™å®šä¸€æ¡ input æ•°æ®ï¼Œå½“å‰æ¨¡å‹é¢„æµ‹çš„ sentence å°†åˆ†åˆ«ä»¥å…¶ä»–å‡ ä¸ªæ¨¡å‹çš„é¢„æµ‹çš„ sentence ä½œä¸ºä¼ª ground truth æ¥è®¡ç®— BLEU_4 scoreï¼Œæ±‚å’Œä½œä¸ºå½“å‰æ¨¡å‹é¢„æµ‹çš„ sentence çš„åˆ†å€¼ã€‚  
 > 2. å…¶ä»–å‡ ä¸ªæ¨¡å‹é¢„æµ‹çš„ sentence åŒæ ·æŒ‰æ­¥éª¤ 1 æ–¹å¼è®¡ç®—è‡ªå·±çš„å¾—åˆ†ã€‚  
 > 3. æœ€åå–å¾—åˆ†æœ€é«˜çš„ sentence æœ€ä¸ºæœ€åæäº¤çš„ç»“æœã€‚  
 - æ¨ç†æ—¶æ–½åŠ é‡å¤è¾“å‡º token æƒ©ç½šï¼Œé¿å…æ¨¡å‹åå¤è¾“å‡ºåŒæ ·çš„ tokenï¼›æ¨ç†ä¸­é˜²æ­¢ 5 gram tokens åŠæ›´é•¿çš„ n gram tokens å‡ºç° 2 æ¬¡ã€‚  

### ç®—æ³•çš„å…¶ä»–ç»†èŠ‚ï¼ˆå¯é€‰ï¼‰  
- é¢„è®­ç»ƒå¿…ä¸å¯å°‘ï¼šé¢„è®­ç»ƒä¸ä»…å¯ä»¥åŠ é€Ÿ finetune é˜¶æ®µçš„æ”¶æ•›ï¼Œè€Œä¸”å¯ä»¥æé«˜ finetune çš„æŒ‡æ ‡ä¸Šé™  
- é¢„è®­ç»ƒçš„ step éœ€è¦é€‚ä¸­ï¼šå¤ªå°‘ä¼šæ¬ æ‹Ÿåˆï¼Œå¤ªå¤šè¿‡æ‹Ÿåˆã€‚ç»å®éªŒï¼Œé‡‡ç”¨æœ¬é¡¹ç›®çš„ pretrain ä»£ç ï¼Œå¯ä»¥ 1e-6 ï½ 2e-5 learning rateã€256 batch size è®­ç»ƒ 10w stepsï¼Œå¾—åˆ°è¾ƒä¸é”™çš„é¢„è®­ç»ƒå‚æ•°  
- ä¸€ä¸ªå¯ä»¥æé«˜æ•°æ®è®­ç»ƒåˆ©ç”¨ç‡çš„æ–¹å¼ï¼šå…ˆåˆ’åˆ†å‡º dev æ¥ pretrainï¼Œæ ¹æ® pretrain è¿‡ç¨‹ä¸­ dev ä¸Šçš„æŒ‡æ ‡å˜åŒ–åˆ¤æ–­èƒ½å¤Ÿé¿å…æ¨¡å‹è¿‡æ‹Ÿåˆçš„åˆç† step æ•° Nï¼Œç„¶åå†ç”¨æ‰€æœ‰çš„æ•°æ® pretrain N steps å·¦å³ã€‚åŒç†ï¼Œåœ¨ finetune é˜¶æ®µä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼æ“ä½œï¼Œä»è€Œé¿å…æ¨¡å‹åœ¨å…¨é‡æ•°æ®è®­ç»ƒä¸­è¿‡æ‹Ÿåˆã€‚  
- ä¸€ä¸ªå‡å°‘æ¨¡å‹å¤§å°å’Œæ˜¾å­˜å ç”¨çš„æ–¹æ³•ï¼šç»ç»Ÿè®¡ï¼Œåˆèµ› + å¤èµ›æ•°æ®çš„æ€» token æ•°ä¸º ***1628***ï¼ŒåŠ ä¸Š 6 ä¸ª special tokensï¼Œ(e.g.: [CLS]ã€[EOS]ã€[MASK]ã€[PAD]ã€[SEP]ã€[UNK]) ï¼Œå…± ***1634*** ä¸ª tokenï¼Œå°† é¢„è®­ç»ƒæ¨¡å‹åµŒå…¥å±‚ä¹Ÿåˆå§‹åŒ–ä¸º ***1634***ã€‚è¯¥æ“ä½œä½¿å¾—åµŒå…¥å±‚å‘é‡æ•°ä» 5w+ å‡å°‘ä¸º 1634ã€‚  

## è®­ç»ƒæµç¨‹  
åœ¨ã€Œè®­ç»ƒã€notebook ä¸­é€ cell è¿è¡Œå³å¯  
notebook åŒ…æ‹¬ å˜é‡è®¾ç½®ã€é¢„å¤„ç†æ•°æ®ã€DEBUGé˜¶æ®µã€æ­£å¼è®­ç»ƒé˜¶æ®µã€ä¿å­˜æ¨¡å‹é˜¶æ®µï¼š  
> å˜é‡è®¾ç½®ï¼šå°† python æ–‡ä»¶è·¯å¾„åŠ å…¥ os.pathï¼Œä»è€Œè®© notebook æ¥ import function  
> é¢„å¤„ç†æ•°æ®ï¼šå°† åˆèµ› + å¤èµ› æ•°æ®å¤„ç†ä¸ºè®­ç»ƒè„šæœ¬éœ€è¦çš„æ ¼å¼ï¼ˆåŒ…æ‹¬å°†å¤èµ›æ•°æ®ä¸­çš„ clinical ä¸ description æ‹¼æ¥ï¼‰ï¼Œç”¨äº k fold cross validation ä»¥åŠ pretrain  
> DEBUGé˜¶æ®µï¼šç”¨äºè°ƒè¯•ä»£ç ï¼Œ**å·²è¢«æ³¨é‡Š**ï¼Œè‹¥éœ€è¦ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šç”¨ä»¥è°ƒè¯•ã€‚ï¼ˆå› ä¸º 10w çº§æ•°æ®é‡åšæ–‡æœ¬ç”Ÿæˆç”¨ V100 è®­ç»ƒé€Ÿåº¦å¤ªæ…¢ï¼Œæ‰€ä»¥è¯¥ç¯èŠ‚ä½¿ç”¨å°‘é‡çš„ debug æ•°æ®ä»£æ›¿æ¯ä¸ª fold æ•°æ®æ¥åˆ†åˆ«è®­ç»ƒ 1 epochï¼Œå¾—åˆ°å¯¹åº”çš„æ¨¡å‹ï¼Œç¡®ä¿æ•´ä¸ªæµç¨‹èƒ½å¤Ÿè·‘é€šï¼‰  
> æ­£å¼è®­ç»ƒé˜¶æ®µï¼šåˆ†åˆ« finetune fold1ã€fold2ã€fold3 çš„æ•°æ®ï¼Œç”¨äºæ¨¡å‹ç»“æœçš„æŠ•ç¥¨  
> ä¿å­˜æ¨¡å‹é˜¶æ®µï¼šå°†æ¯ä¸ª fold æ•°æ® finetune å‡ºçš„çš„æ¨¡å‹ä¿å­˜äº best_model è·¯å¾„ä¸‹å¯¹åº”çš„ä½ç½®ï¼Œç”¨äºæ¨ç†é˜¶æ®µä½¿ç”¨  

## æ¨ç†æµç¨‹  
åœ¨ã€Œæ¨ç†ã€notebook ä¸­é€ cell è¿è¡Œå³å¯  
notebook åŒ…æ‹¬ å˜é‡è®¾ç½®ã€æ¨ç†DEBUGé˜¶æ®µã€æ­£å¼æ¨ç†é˜¶æ®µï¼š  
> å˜é‡è®¾ç½®ï¼šå°† python æ–‡ä»¶è·¯å¾„åŠ å…¥ os.pathï¼Œä»è€Œè®© notebook æ¥ import function  
> æ¨ç†DEBUGé˜¶æ®µï¼šç”¨äºè°ƒè¯•ä»£ç ï¼Œ**å·²è¢«æ³¨é‡Š**ï¼Œè‹¥éœ€è¦ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šç”¨ä»¥è°ƒè¯•ã€‚ï¼ˆå…¶ä¸­åŒ…æ‹¬ debug æ•°æ®å¤„ç†ä»¥åŠé¢„æµ‹ debug è¾“å…¥æ•°æ®çš„ç»“æœï¼Œç”Ÿæˆ debug results æ–‡ä»¶ äº temp ä¸´æ—¶ç©ºé—´ä¸‹  ï¼‰  
> æ­£å¼æ¨ç†é˜¶æ®µï¼šè°ƒç”¨è®­ç»ƒæµç¨‹ä¿å­˜çš„ n (æ­¤å¤„ä¸º 3)ä¸ªæ¨¡å‹æ¥æ¨ç†è¾“å…¥çš„æµ‹è¯•é›†çš„ç»“æœï¼Œç„¶åå¯¹å¤šä¸ªç»“æœè¿›è¡ŒæŠ•ç¥¨ä»¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œè¾“å‡ºåˆ°ç›®æ ‡è·¯å¾„ä¸‹ã€‚  
> - ç»†èŠ‚ 1ï¼šè®¾ç½® no_repeat_ngram_size=5ï¼Œåœ¨æ¨ç†ä¸­è®© 5 gram æˆ–ä»¥ä¸Šçš„ span æœ€å¤šé‡å¤ 1 æ¬¡ã€‚  
> - ç»†èŠ‚ 2ï¼šè®¾ç½® repetition_penalty=1.2ï¼Œæ–½åŠ  é‡å¤è¾“å‡º æƒ©ç½šï¼Œå‡å°æ¨¡å‹è¾“å‡º token çš„é‡å¤ç‡ã€‚  

## å…¶ä»–æ³¨æ„äº‹é¡¹  
æ•°æ®çš„åˆ’åˆ†éœ€è¦æŒ‰ç…§ notebook çš„æµç¨‹æ¥ é€cell è¿è¡Œï¼Œå…¶ä¸­å·²ç»è®¾å®šå¥½äº† seed ä»¥ä¿è¯æ¯æ¬¡ä»å¤´è¿è¡Œå¾—åˆ°ç›¸åŒçš„æ•°æ®åˆ’åˆ†ç»“æœã€‚
```
import os
import torch
os.environ["CUDA_VISIBLE_DEVICES"]=os.environ["NVIDIA_VISIBLE_DEVICES"]
torch.cuda.get_device_name(0), torch.cuda.is_available()  # ç¡®è®¤ gpu æ­£å¸¸ä½¿ç”¨
temp_save_dir = '/home/mw/temp/'

import os
if not os.path.exists(temp_save_dir):  # ä¸ªåˆ«æœºå™¨å¯èƒ½æ²¡æœ‰ temp è·¯å¾„
    os.mkdir(temp_save_dir) # ç”Ÿæˆç”¨äºä¿å­˜å¦å¤–å‡ ä¸ªfoldçš„ best model çš„è·¯å¾„
```